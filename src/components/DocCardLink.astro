---
import { Icon } from '@astrojs/starlight/components';
import type { HTMLAttributes } from 'astro/types';
import { documentsInfo } from '../data/documents.ts';

interface Document {
  type: string;
  number: string;
  description: string;
  link_text: string;
  link: string | null;
}

interface Documents {
  [key: string]: Document;
}

interface DocumentsInfo {
  documents: Documents;
  last_update: string;
}

interface Props extends Omit<HTMLAttributes<'a'>, 'title'> {
  title?: string;
  description?: string;
  ref?: string | number;
  class?: string;
}

const { title, description, ref, class: className = '', ...attributes } = Astro.props;

let cardTitle = title;
let cardDescription = description;
let link = attributes.href;

if (ref) {
  const key = String(ref);
  const doc: Document | undefined = (documentsInfo as DocumentsInfo).documents[key];

  if (!doc) {
    throw new Error(`LinkCard: no se encontr√≥ documento con ref "${key}"`);
  }

  cardTitle = description || doc.description || 'Descarga el documento';
  cardDescription = title || doc.link_text || 'Descargar';
  link = doc.link || undefined;
}
---

{link ? (
    <div class={`sl-link-card ${className}`}>
      <span class="sl-flex stack">
        <a {...attributes} href={link} target="_blank">
          <span class="title" set:html={cardTitle} />
        </a>
        {cardDescription && <span class="description" set:html={cardDescription} />}
      </span>
      {className.includes('download-icon') ? null : (
        <Icon name="download" size="1.333em" class="icon rtl:flip" />
      )}
    </div>
) : (
  <p>{cardDescription}</p>
)}

<style>
  @layer starlight.components {
    .sl-link-card {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      border: 1px solid var(--sl-color-gray-5);
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: var(--sl-shadow-sm);
      position: relative;
      margin-top: 2rem;
      margin-bottom: 2rem;
    }

    a {
      text-decoration: none;
      line-height: var(--sl-line-height-headings);
    }

    /* a11y fix for https://github.com/withastro/starlight/issues/487 */
    a::before {
      content: '';
      position: absolute;
      inset: 0;
    }

    .stack {
      flex-direction: column;
      gap: 0.5rem;
    }

    .title {
      color: var(--sl-color-white);
      font-weight: 600;
      font-size: var(--sl-text-lg);
    }

    .description {
      color: var(--sl-color-gray-3);
      line-height: 1.5;
    }

    .icon {
      color: var(--sl-color-gray-3);
    }

    /* Hover state */
    .sl-link-card:hover {
      background: var(--sl-color-gray-7, var(--sl-color-gray-6));
      border-color: var(--sl-color-gray-2);
    }

    .sl-link-card:hover .icon {
      color: var(--sl-color-white);
    }

    /* Hide default icon when download-icon class is used */
    .download-icon::before {
      display: none;
    }
  }
</style>