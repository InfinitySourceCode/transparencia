---
import { Icon } from '@astrojs/starlight/components';
import type { HTMLAttributes } from 'astro/types';
import { documentsInfo } from '../data/documents.ts';

interface Document {
  type: string;
  number: string;
  description: string;
  link_text: string;
  link: string | null;
}

interface Documents {
  [key: string]: Document;
}

interface DocumentsInfo {
  documents: Documents;
  last_update: string;
}

interface Props extends Omit<HTMLAttributes<'a'>, 'title'> {
  title?: string;
  description?: string;
  ref?: string | number;
  class?: string;
}

const { title, description, ref, class: className = '', ...attributes } = Astro.props;

let cardTitle = title;
let cardDescription = description;
let link = attributes.href;

if (ref) {
  const key = String(ref);
  const doc: Document | undefined = (documentsInfo as DocumentsInfo).documents[key];

  if (!doc) {
    throw new Error(`LinkCard: no se encontró documento con ref "${key}"`);
  }

  cardTitle = description || doc.description || 'Descarga el documento';
  cardDescription = title || doc.link_text || 'Descargar';
  link = doc.link || undefined;
}
---

{link ? (
    <div class={`sl-link-card ${className}`}>
      <span class="sl-flex stack">
        <a {...attributes} href={link} target="_blank">
          <span class="title" set:html={cardTitle} />
        </a>
        {cardDescription && <span class="description" set:html={cardDescription} />}
      </span>
      {className.includes('download-icon') ? null : (
        <Icon name="cloud-download" size="2em" class="icon rtl:flip accent-color" />
      )}
    </div>
) : (
  <p>{cardDescription}</p>
)}

<style>
  @layer starlight.components {
    /* 
     * Contenedor principal de la tarjeta de enlace.
     * Usa CSS Grid para alinear el contenido y el icono de descarga.
     */
    .sl-link-card {
      display: grid; /* Diseño de cuadrícula */
      grid-template-columns: 1fr auto; /* Contenido principal y icono */
      gap: 0.5rem; /* Espacio entre columnas */
      border: 1px solid var(--sl-color-gray-5); /* Borde gris claro */
      border-radius: 0.5rem; /* Bordes redondeados */
      padding: 1rem; /* Espacio interno */
      box-shadow: var(--sl-shadow-sm); /* Sombra ligera */
      position: relative; /* Para el a11y fix del enlace */
      margin-top: 2rem; /* Espacio superior */
      margin-bottom: 2rem; /* Espacio inferior */
    }

    /* 
     * Estiliza el enlace dentro de la tarjeta.
     * Elimina el subrayado predeterminado para un diseño limpio.
     */
    a {
      text-decoration: none; /* Sin subrayado en el enlace */
      line-height: var(--sl-line-height-headings); /* Altura de línea consistente */
    }

    /* 
     * Corrige problemas de accesibilidad (https://github.com/withastro/starlight/issues/487).
     * Añade un área clicable que cubre toda la tarjeta.
     */
    a::before {
      content: ''; /* Elemento vacío */
      position: absolute; /* Cubre toda la tarjeta */
      inset: 0; /* Ocupa todo el espacio del contenedor */
    }

    /* 
     * Contenedor para el título y la descripción.
     * Usa flexbox para apilarlos verticalmente.
     */
    .stack {
      flex-direction: column; /* Apila elementos verticalmente */
      gap: 0.5rem; /* Espacio entre título y descripción */
    }

    /* 
     * Estiliza el título de la tarjeta.
     * Usa una fuente más gruesa y un tamaño mayor.
     */
    .title {
      font-weight: 600; /* Peso de fuente seminegrita */
      font-size: var(--sl-text-lg); /* Tamaño de fuente grande */
    }

    /* 
     * Estiliza el texto descriptivo de la tarjeta.
     * Usa un color de acento, subrayado para simular un enlace, y espaciado de línea.
     */
    .description {
      line-height: 1.5; /* Espaciado de línea para legibilidad */
      text-decoration: underline; /* Subrayado para simular un enlace */
    }
    
    .accent-color {
      color: var(--sl-color-text-accent) !important; /* Color de acento de Starlight */
    }

    .sl-link-card:hover .description {
      font-weight: 500!important;
    }

    /* 
     * Estiliza el icono de descarga.
     * Usa un color gris claro para visibilidad.
     */
    .icon {
      color: var(--sl-color-gray-3); /* Color gris claro */
    }

    /* 
     * Efecto hover para la tarjeta.
     * Cambia el fondo y el color del borde.
     */
    .sl-link-card:hover {
      background: var(--sl-color-gray-7, var(--sl-color-gray-6)); /* Fondo más oscuro */
      border-color: var(--sl-color-gray-2); /* Borde más claro */
    }

    /* 
     * Cambia el color del icono al hacer hover.
     */
    .sl-link-card:hover .icon {
      color: var(--sl-color-white); /* Icono blanco en hover */
    }

    /* 
     * Oculta el icono predeterminado cuando se usa la clase download-icon.
     */
    .download-icon::before {
      display: none; /* Oculta el pseudo-elemento */
    }
  }
</style>